/**
 * msg.js
 *
 * Base module that other message modules use.
 */
'use strict';

const Client = require('../include/client.js');
const Parser = require('./parser.js');

/**
 * Base inteface for other message classes.
 */
class Message {
    /**
     * Class constructor.
     * @param {Parser} parser Parser instance
     * @param {string} raw Unparsed message from WikiaRC
     * @param {string} type Message type
     */
    constructor(parser, raw, type) {
        this._parser = parser;
        this.raw = raw;
        this.type = type;
        this.error = false;
    }
    /**
     * Marks a message as errored out.
     * @param {string} code Error code
     * @param {string} message Error message
     * @param {object} details Error details
     * @protected
     */
    _error(code, message, details) {
        this.error = code;
        this.errmsg = message;
        this.errdetails = details;
    }
    /**
     * Starts fetching more details about the message.
     * @param {Client} _client Client instance to get external clients from
     * @param {string[]} _properties Details to fetch
     */
    fetch(_client, _properties) {
        // To be implemented by subclasses if needed
    }
    /**
     * Cleans up after a failed fetch.
     * Interested modules and properties to fetch should remain, as they are
     * only generated by the client once.
     */
    cleanup() {
        this.error = false;
        delete this.errmsg;
        delete this.errdetails;
        delete this._client;
        delete this._properties;
    }
    /**
     * Stringifies the object when passed through JSON.stringify.
     * @returns {object} Object to stringify
     */
    toJSON() {
        const clone = {};
        for (const prop in this) {
            if (
                (
                    !prop.startsWith('_') ||
                    typeof this[prop] === 'string'
                ) &&
                typeof this[prop] !== 'function'
            ) {
                clone[prop] = this[prop];
            }
        }
        return clone;
    }
}

module.exports = Message;
